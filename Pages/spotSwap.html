<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot Swap - Parking Pal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="../Styles/index.css">
</head>
<body>
    <nav class="navbar bg-mPurple">
        <div class="container-fluid">
            <div class="navbar-nav mx-auto">
                <a href="../index.html" class="navbar-brand text-white text-decoration-none d-flex align-items-center">
                    <img src="../Images/ParkPalLogo.png" alt="Parking Pal Logo" height="40" class="me-2">
                    <h1 id="header" class="mb-0 fw-bold">Parking Pal</h1>
                </a>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#Menu" aria-controls="Menu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="Menu">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="./parkingPal.html">Parking Pal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="./spotSwap.html">Spot Swap</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="./viewRequests.html">View Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="./signIn.html">Sign In</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="./makeAccount.html">Create Account</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="./meetTheTeam.html">Meet the Team</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="text-center mb-5">Spot Swap</h1>
        
        <div class="row">
            <!-- Looking for a Spot Box -->
            <div class="col-md-6 mb-4">
                <div class="card h-100 purple-border">
                    <div class="card-header bg-mPurple text-white">
                        <h3 class="card-title mb-0">Looking for a Spot</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Need a parking spot? Let others know you're looking!</p>
                        
                        <!-- Sign In Section -->
                        <div class="mb-3" id="lookingSignInSection">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Quick Sign In</h6>
                                <p class="mb-2">Sign in to auto-fill your information</p>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <input type="text" class="form-control" id="lookingAccountName" placeholder="Account name">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <input type="password" class="form-control" id="lookingPassword" placeholder="Password">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="signInLooking()">Sign In</button>
                                    <small class="text-muted">Don't have an account? <a href="./makeAccount.html">Create one</a></small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sign Out Section -->
                        <div class="mb-3" id="lookingSignOutSection" style="display: none;">
                            <div class="alert alert-success">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Signed in as: <strong id="lookingCurrentUser"></strong></span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="signOutLooking()">Sign Out</button>
                                </div>
                            </div>
                        </div>
                        
                        <form>
                            <div class="mb-3">
                                <label for="lookingCampus" class="form-label">Campus</label>
                                <select class="form-select" id="lookingCampus" onchange="updateLookingParkingLocations()">
                                    <option selected>Choose campus...</option>
                                    <option value="ua-tuscaloosa">University of Alabama - Tuscaloosa</option>
                                    <option value="ua-birmingham">University of Alabama - Birmingham</option>
                                    <option value="ua-huntsville">University of Alabama - Huntsville</option>
                                    <option value="auburn">Auburn</option>
                                </select>
                            </div>
                            <div class="mb-3" id="lookingUserTypeSection" style="display: none;">
                                <label for="lookingUserType" class="form-label">Are you a student or faculty/staff?</label>
                                <select class="form-select" id="lookingUserType">
                                    <option value="" selected disabled>Select your status</option>
                                    <option value="student">Student</option>
                                    <option value="faculty-staff">Faculty/Staff</option>
                                </select>
                            </div>
                            <div class="mb-3" id="lookingStudentTypeSection" style="display: none;">
                                <label for="lookingStudentType" class="form-label">Are you a commuter or residential student?</label>
                                <select class="form-select" id="lookingStudentType">
                                    <option value="" selected disabled>Select your student type</option>
                                    <option value="commuter">Commuter</option>
                                    <option value="residential">Residential</option>
                                </select>
                            </div>
                            <div class="mb-3" id="lookingParkingPassSection" style="display: none;">
                                <label for="lookingParkingPass" class="form-label">Which parking pass do you have?</label>
                                <select class="form-select" id="lookingParkingPass">
                                    <option value="" selected disabled>Select your parking pass</option>
                                </select>
                            </div>
                            <div class="mb-3" id="lookingMessageSection" style="display: none;">
                                <label for="lookingMessage" class="form-label">Message (Optional)</label>
                                <textarea class="form-control" id="lookingMessage" rows="3" placeholder="Orange Magnolia Parking Deck"></textarea>
                            </div>
                            <button type="submit" class="btn bg-mPurple text-white w-100">Post Request</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Giving up a Spot Box -->
            <div class="col-md-6 mb-4">
                <div class="card h-100 purple-border">
                    <div class="card-header bg-mPurple text-white">
                        <h3 class="card-title mb-0">Giving up a Spot</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Have a spot to give away? Share it with the community!</p>
                        <form>
                            <div class="mb-3">
                                <label for="givingAccountName" class="form-label">Account Name</label>
                                <input type="text" class="form-control" id="givingAccountName" placeholder="Enter your account name" required>
                                <small class="form-text text-muted">Don't have an account? <a href="./makeAccount.html">Create one here</a></small>
                            </div>
                            <div class="mb-3">
                                <label for="givingCampus" class="form-label">Campus</label>
                                <select class="form-select" id="givingCampus" onchange="updateParkingLocations()">
                                    <option selected>Choose campus...</option>
                                    <option value="ua-tuscaloosa">University of Alabama - Tuscaloosa</option>
                                    <option value="ua-birmingham">University of Alabama - Birmingham</option>
                                    <option value="ua-huntsville">University of Alabama - Huntsville</option>
                                    <option value="auburn">Auburn</option>
                                </select>
                            </div>
                            <div class="mb-3" id="givingUserTypeSection" style="display: none;">
                                <label for="givingUserType" class="form-label">Are you a student or faculty/staff?</label>
                                <select class="form-select" id="givingUserType">
                                    <option value="" selected disabled>Select your status</option>
                                    <option value="student">Student</option>
                                    <option value="faculty-staff">Faculty/Staff</option>
                                </select>
                            </div>
                            <div class="mb-3" id="givingStudentTypeSection" style="display: none;">
                                <label for="givingStudentType" class="form-label">Are you a commuter or residential student?</label>
                                <select class="form-select" id="givingStudentType">
                                    <option value="" selected disabled>Select your student type</option>
                                    <option value="commuter">Commuter</option>
                                    <option value="residential">Residential</option>
                                </select>
                            </div>
                            <div class="mb-3" id="givingParkingPassSection" style="display: none;">
                                <label for="givingParkingPass" class="form-label">Which parking pass do you have?</label>
                                <select class="form-select" id="givingParkingPass">
                                    <option value="" selected disabled>Select your parking pass</option>
                                </select>
                            </div>
                            <div class="mb-3" id="givingTimeSection" style="display: none;">
                                <label for="givingTime" class="form-label">Time willing to wait</label>
                                <select class="form-select" id="givingTime">
                                    <option selected>Choose time...</option>
                                    <option value="1">1 minute</option>
                                    <option value="2">2 minutes</option>
                                    <option value="3">3 minutes</option>
                                    <option value="4">4 minutes</option>
                                    <option value="5">5 minutes</option>
                                    <option value="6">6 minutes</option>
                                    <option value="7">7 minutes</option>
                                    <option value="8">8 minutes</option>
                                    <option value="9">9 minutes</option>
                                    <option value="10">10 minutes</option>
                                </select>
                            </div>
                            <div class="mb-3" id="givingVehicleInfoSection" style="display: none;">
                                <h6 class="form-label fw-bold">Vehicle Information (Required)</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="givingCarYear" class="form-label">Year</label>
                                        <input type="number" class="form-control" id="givingCarYear" placeholder="2020" min="1990" max="2024" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="givingCarMake" class="form-label">Make</label>
                                        <input type="text" class="form-control" id="givingCarMake" placeholder="Honda" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="givingCarModel" class="form-label">Model</label>
                                        <input type="text" class="form-control" id="givingCarModel" placeholder="Civic" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="givingCarColor" class="form-label">Color</label>
                                        <input type="text" class="form-control" id="givingCarColor" placeholder="Silver" required>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="givingFloor" class="form-label">Floor/Level</label>
                                        <input type="text" class="form-control" id="givingFloor" placeholder="3rd floor, Level 2, etc." required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3" id="givingMessageSection" style="display: none;">
                                <label for="givingMessage" class="form-label">Additional Details (Optional)</label>
                                <textarea class="form-control" id="givingMessage" rows="3" placeholder="Ex: Orange, Magnolia Parking Deck 3rd floor, Black Honda Pilot"></textarea>
                            </div>
                            <button type="submit" class="btn bg-mPurple text-white w-100" id="postSpotBtn">Post Spot</button>
                        </form>
                        <div class="alert alert-danger mt-3" id="accountError" style="display: none;">
                            <strong>Account Required!</strong> <span id="accountErrorText"></span>
                        </div>
                        
                        <!-- Countdown Timer Section -->
                        <div class="alert alert-info mt-3" id="countdownSection" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Spot Posted!</strong> Waiting for someone to claim your spot...
                                </div>
                                <div class="text-end">
                                    <div class="h4 mb-0 text-primary" id="countdownTimer">00:00</div>
                                    <small class="text-muted">Time remaining</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User's Active Requests Section -->
        <div class="row justify-content-center mt-4">
            <div class="col-md-10">
                <div class="card shadow purple-border">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>Your Active Requests
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Manage your active spot swap requests. You can have multiple requests active at once!</p>
                        <div id="userActiveRequests">
                            <p class="text-muted">Sign in to view your active requests</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    
    <script>
        // Check if account exists in local storage
        function doesAccountExist(accountName) {
            const accounts = JSON.parse(localStorage.getItem('parkingAccounts') || '[]');
            return accounts.some(account => account.name.toLowerCase() === accountName.toLowerCase());
        }

        // Load saved account data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedAccountData();
            checkLookingSignInStatus();
        });

        // Function to load saved account data
        function loadSavedAccountData() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
            if (currentUser) {
                // Pre-fill giving up a spot form
                document.getElementById('givingCampus').value = currentUser.campus || '';
                if (currentUser.campus) {
                    updateParkingLocations();
                    document.getElementById('givingUserType').value = currentUser.userType || '';
                    if (currentUser.userType) {
                        updateGivingUserType();
                        if (currentUser.studentType) {
                            document.getElementById('givingStudentType').value = currentUser.studentType;
                            updateGivingStudentType();
                        }
                        if (currentUser.parkingPass) {
                            document.getElementById('givingParkingPass').value = currentUser.parkingPass;
                            updateGivingParkingPass();
                        }
                    }
                }
                
                // Pre-fill looking for a spot form
                document.getElementById('lookingCampus').value = currentUser.campus || '';
                if (currentUser.campus) {
                    updateLookingParkingLocations();
                    document.getElementById('lookingUserType').value = currentUser.userType || '';
                    if (currentUser.userType) {
                        updateLookingUserType();
                        if (currentUser.studentType) {
                            document.getElementById('lookingStudentType').value = currentUser.studentType;
                            updateLookingStudentType();
                        }
                        if (currentUser.parkingPass) {
                            document.getElementById('lookingParkingPass').value = currentUser.parkingPass;
                            updateLookingParkingPass();
                        }
                    }
                }
            }
        }

        // Check if user is already signed in for looking section
        function checkLookingSignInStatus() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
            if (currentUser) {
                showLookingSignOutSection(currentUser.name);
            } else {
                showLookingSignInSection();
            }
        }

        // Show sign in section
        function showLookingSignInSection() {
            document.getElementById('lookingSignInSection').style.display = 'block';
            document.getElementById('lookingSignOutSection').style.display = 'none';
        }

        // Show sign out section
        function showLookingSignOutSection(userName) {
            document.getElementById('lookingSignInSection').style.display = 'none';
            document.getElementById('lookingSignOutSection').style.display = 'block';
            document.getElementById('lookingCurrentUser').textContent = userName;
        }

        // Sign in for looking section
        function signInLooking() {
            const accountName = document.getElementById('lookingAccountName').value.trim();
            const password = document.getElementById('lookingPassword').value;
            
            if (!accountName || !password) {
                alert('Please enter both account name and password.');
                return;
            }
            
            // Validate credentials
            const accounts = JSON.parse(localStorage.getItem('parkingAccounts') || '[]');
            const account = accounts.find(acc => 
                acc.name.toLowerCase() === accountName.toLowerCase() && 
                acc.password === password
            );
            
            if (account) {
                // Store current user in session
                sessionStorage.setItem('currentUser', JSON.stringify(account));
                
                // Show sign out section
                showLookingSignOutSection(account.name);
                
                // Pre-fill the form
                loadSavedAccountData();
                
                // Clear sign in fields
                document.getElementById('lookingAccountName').value = '';
                document.getElementById('lookingPassword').value = '';
                
                // Display user's active requests
                displayUserActiveRequests(account.name);
                
                alert('Successfully signed in! Your information has been auto-filled.');
            } else {
                alert('Invalid account name or password. Please try again.');
            }
        }

        // Sign out for looking section
        function signOutLooking() {
            sessionStorage.removeItem('currentUser');
            showLookingSignInSection();
            
            // Clear the form
            document.getElementById('lookingCampus').selectedIndex = 0;
            document.getElementById('lookingUserType').selectedIndex = 0;
            document.getElementById('lookingStudentType').selectedIndex = 0;
            document.getElementById('lookingParkingPass').selectedIndex = 0;
            document.getElementById('lookingMessage').value = '';
            
            // Hide all sections
            document.getElementById('lookingUserTypeSection').style.display = 'none';
            document.getElementById('lookingStudentTypeSection').style.display = 'none';
            document.getElementById('lookingParkingPassSection').style.display = 'none';
            document.getElementById('lookingMessageSection').style.display = 'none';
        }

        // Handle form submission for giving up a spot
        document.querySelector('#givingCampus').closest('form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const accountName = document.getElementById('givingAccountName').value.trim();
            const campus = document.getElementById('givingCampus').value;
            const userType = document.getElementById('givingUserType').value;
            const studentType = document.getElementById('givingStudentType').value;
            const parkingPass = document.getElementById('givingParkingPass').value;
            const timeWait = document.getElementById('givingTime').value;
            const carYear = document.getElementById('givingCarYear').value;
            const carMake = document.getElementById('givingCarMake').value.trim();
            const carModel = document.getElementById('givingCarModel').value.trim();
            const carColor = document.getElementById('givingCarColor').value.trim();
            const floor = document.getElementById('givingFloor').value.trim();
            const message = document.getElementById('givingMessage').value.trim();
            
            const accountError = document.getElementById('accountError');
            const accountErrorText = document.getElementById('accountErrorText');
            
            // Hide error message
            accountError.style.display = 'none';
            
            // Check if account name is provided
            if (!accountName) {
                accountErrorText.textContent = 'Please enter your account name.';
                accountError.style.display = 'block';
                return;
            }
            
            // Check if account exists
            if (!doesAccountExist(accountName)) {
                accountErrorText.textContent = `Account "${accountName}" does not exist. Please create an account first.`;
                accountError.style.display = 'block';
                return;
            }
            
            // Check if all required fields are filled
            if (!campus || campus === 'Choose campus...') {
                accountErrorText.textContent = 'Please select a campus.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!userType) {
                accountErrorText.textContent = 'Please select whether you are a student or faculty/staff.';
                accountError.style.display = 'block';
                return;
            }
            
            if (userType === 'student' && campus !== 'auburn' && !studentType) {
                accountErrorText.textContent = 'Please select whether you are a commuter or residential student.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!parkingPass) {
                accountErrorText.textContent = 'Please select your parking pass.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!timeWait || timeWait === 'Choose time...') {
                accountErrorText.textContent = 'Please select how long you are willing to wait.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!carYear) {
                accountErrorText.textContent = 'Please enter your car year.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!carMake) {
                accountErrorText.textContent = 'Please enter your car make.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!carModel) {
                accountErrorText.textContent = 'Please enter your car model.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!carColor) {
                accountErrorText.textContent = 'Please enter your car color.';
                accountError.style.display = 'block';
                return;
            }
            
            if (!floor) {
                accountErrorText.textContent = 'Please enter the floor/level where your spot is located.';
                accountError.style.display = 'block';
                return;
            }
            
            // If all validations pass, store spot data and start countdown timer
            storeSpotData(accountName, campus, parkingPass, timeWait, message, carYear, carMake, carModel, carColor, floor);
            startCountdown(parseInt(timeWait));
            
            // Reset form
            this.reset();
            document.getElementById('givingUserTypeSection').style.display = 'none';
            document.getElementById('givingStudentTypeSection').style.display = 'none';
            document.getElementById('givingParkingPassSection').style.display = 'none';
            document.getElementById('givingTimeSection').style.display = 'none';
            document.getElementById('givingVehicleInfoSection').style.display = 'none';
            
            // Display user's active requests
            displayUserActiveRequests(accountName);
            document.getElementById('givingMessageSection').style.display = 'none';
        });

        // Handle form submission for looking for a spot
        document.querySelector('#lookingCampus').closest('form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const campus = document.getElementById('lookingCampus').value;
            const userType = document.getElementById('lookingUserType').value;
            const studentType = document.getElementById('lookingStudentType').value;
            const parkingPass = document.getElementById('lookingParkingPass').value;
            const message = document.getElementById('lookingMessage').value.trim();
            
            // Check if all required fields are filled
            if (!campus || campus === 'Choose campus...') {
                alert('Please select a campus.');
                return;
            }
            
            if (!userType) {
                alert('Please select whether you are a student or faculty/staff.');
                return;
            }
            
            if (userType === 'student' && campus !== 'auburn' && !studentType) {
                alert('Please select whether you are a commuter or residential student.');
                return;
            }
            
            if (!parkingPass) {
                alert('Please select your parking pass.');
                return;
            }

            // Persist the looking request so it appears on View Requests
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
            const requesterName = currentUser ? currentUser.name : 'Anonymous';
            const lookingRequest = {
                id: Date.now(),
                type: 'looking',
                accountName: requesterName,
                campus: campus,
                location: parkingPass,
                message: message,
                createdAt: new Date().toISOString(),
                // Looking requests expire after 60 minutes by default
                expiresAt: new Date(Date.now() + (60 * 60 * 1000)).toISOString()
            };
            const existingLooking = JSON.parse(localStorage.getItem('lookingRequests') || '[]');
            existingLooking.push(lookingRequest);
            localStorage.setItem('lookingRequests', JSON.stringify(existingLooking));
            cleanupExpiredLookingRequests();
            
            // Look for matching spots using parking pass as location
            const match = findMatchingSpot(campus, parkingPass);
            
            if (match) {
                displayCarInformation(match);
                // Only reset form if a match is found
                this.reset();
                document.getElementById('lookingUserTypeSection').style.display = 'none';
                document.getElementById('lookingStudentTypeSection').style.display = 'none';
                document.getElementById('lookingParkingPassSection').style.display = 'none';
                document.getElementById('lookingMessageSection').style.display = 'none';
            } else {
                // Show no spots message without resetting form
                showNoSpotsMessage();
            }
        });

        // Real-time account validation
        document.getElementById('givingAccountName').addEventListener('input', function() {
            const accountName = this.value.trim();
            const accountError = document.getElementById('accountError');
            
            if (accountName && !doesAccountExist(accountName)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Handle user type change for looking for a spot
        document.getElementById('lookingUserType').addEventListener('change', function() {
            const campus = document.getElementById('lookingCampus').value;
            const userType = this.value;
            const studentTypeSection = document.getElementById('lookingStudentTypeSection');
            const parkingPassSection = document.getElementById('lookingParkingPassSection');
            const messageSection = document.getElementById('lookingMessageSection');
            
            // Hide all sections first
            studentTypeSection.style.display = 'none';
            parkingPassSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            // Reset selections
            document.getElementById('lookingStudentType').selectedIndex = 0;
            document.getElementById('lookingParkingPass').selectedIndex = 0;
            document.getElementById('lookingMessage').value = '';
            
            if (userType === 'student') {
                if (campus === 'auburn') {
                    // For Auburn, show parking pass selection directly
                    updateLookingParkingPasses(campus, userType, '');
                } else if (campus === 'ua-huntsville') {
                    // For UAH, show residential/commuter selection
                    studentTypeSection.style.display = 'block';
                } else {
                    // For UAB and UA Tuscaloosa, show residential/commuter selection
                    studentTypeSection.style.display = 'block';
                }
            } else if (userType === 'faculty-staff') {
                // Show faculty/staff parking pass selection
                updateLookingParkingPasses(campus, userType, '');
            }
        });

        // Handle student type change for looking for a spot
        document.getElementById('lookingStudentType').addEventListener('change', function() {
            const campus = document.getElementById('lookingCampus').value;
            const userType = document.getElementById('lookingUserType').value;
            const studentType = this.value;
            const parkingPassSection = document.getElementById('lookingParkingPassSection');
            const messageSection = document.getElementById('lookingMessageSection');
            
            // Hide parking pass and message sections first
            parkingPassSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            // Reset selections
            document.getElementById('lookingParkingPass').selectedIndex = 0;
            document.getElementById('lookingMessage').value = '';
            
            if (studentType === 'residential' || studentType === 'commuter') {
                // Show parking pass selection
                updateLookingParkingPasses(campus, userType, studentType);
            }
        });

        // Handle parking pass change for looking for a spot
        document.getElementById('lookingParkingPass').addEventListener('change', function() {
            const messageSection = document.getElementById('lookingMessageSection');
            
            if (this.value && this.value !== '') {
                // Show message section when a parking pass is selected
                messageSection.style.display = 'block';
            } else {
                // Hide message section when no parking pass is selected
                messageSection.style.display = 'none';
                // Clear message content
                document.getElementById('lookingMessage').value = '';
            }
        });

        // Handle user type change for giving up a spot
        document.getElementById('givingUserType').addEventListener('change', function() {
            const campus = document.getElementById('givingCampus').value;
            const userType = this.value;
            const studentTypeSection = document.getElementById('givingStudentTypeSection');
            const parkingPassSection = document.getElementById('givingParkingPassSection');
            const timeSection = document.getElementById('givingTimeSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            // Hide all sections first
            studentTypeSection.style.display = 'none';
            parkingPassSection.style.display = 'none';
            timeSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            // Reset selections
            document.getElementById('givingStudentType').selectedIndex = 0;
            document.getElementById('givingParkingPass').selectedIndex = 0;
            document.getElementById('givingTime').selectedIndex = 0;
            document.getElementById('givingMessage').value = '';
            
            if (userType === 'student') {
                if (campus === 'auburn') {
                    // For Auburn, show parking pass selection directly
                    updateGivingParkingPasses(campus, userType, '');
                } else if (campus === 'ua-huntsville') {
                    // For UAH, show residential/commuter selection
                    studentTypeSection.style.display = 'block';
                } else {
                    // For UAB and UA Tuscaloosa, show residential/commuter selection
                    studentTypeSection.style.display = 'block';
                }
            } else if (userType === 'faculty-staff') {
                // Show faculty/staff parking pass selection
                updateGivingParkingPasses(campus, userType, '');
            }
        });

        // Handle student type change for giving up a spot
        document.getElementById('givingStudentType').addEventListener('change', function() {
            const campus = document.getElementById('givingCampus').value;
            const userType = document.getElementById('givingUserType').value;
            const studentType = this.value;
            const parkingPassSection = document.getElementById('givingParkingPassSection');
            const timeSection = document.getElementById('givingTimeSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            // Hide parking pass, time, and message sections first
            parkingPassSection.style.display = 'none';
            timeSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            // Reset selections
            document.getElementById('givingParkingPass').selectedIndex = 0;
            document.getElementById('givingTime').selectedIndex = 0;
            document.getElementById('givingMessage').value = '';
            
            if (studentType === 'residential' || studentType === 'commuter') {
                // Show parking pass selection
                updateGivingParkingPasses(campus, userType, studentType);
            }
        });

        // Handle parking pass change for giving up a spot
        document.getElementById('givingParkingPass').addEventListener('change', function() {
            const timeSection = document.getElementById('givingTimeSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            if (this.value && this.value !== '') {
                // Show time section when a parking pass is selected
                timeSection.style.display = 'block';
            } else {
                // Hide time and message sections when no parking pass is selected
                timeSection.style.display = 'none';
                messageSection.style.display = 'none';
                // Reset time selection and clear message
                document.getElementById('givingTime').selectedIndex = 0;
                document.getElementById('givingMessage').value = '';
            }
        });

        // Handle time selection change for giving up a spot
        document.getElementById('givingTime').addEventListener('change', function() {
            const vehicleInfoSection = document.getElementById('givingVehicleInfoSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            if (this.value && this.value !== 'Choose time...') {
                // Show vehicle info section when a time is selected
                vehicleInfoSection.style.display = 'block';
                // Show message section when a time is selected
                messageSection.style.display = 'block';
            } else {
                // Hide vehicle info and message sections when no time is selected
                vehicleInfoSection.style.display = 'none';
                messageSection.style.display = 'none';
                // Clear vehicle info and message content
                document.getElementById('givingCarYear').value = '';
                document.getElementById('givingCarMake').value = '';
                document.getElementById('givingCarModel').value = '';
                document.getElementById('givingCarColor').value = '';
                document.getElementById('givingFloor').value = '';
                document.getElementById('givingMessage').value = '';
            }
        });

        // Function for "Looking for a Spot" campus selection
        function updateLookingParkingLocations() {
            const campus = document.getElementById('lookingCampus').value;
            const userTypeSection = document.getElementById('lookingUserTypeSection');
            const studentTypeSection = document.getElementById('lookingStudentTypeSection');
            const parkingPassSection = document.getElementById('lookingParkingPassSection');
            const messageSection = document.getElementById('lookingMessageSection');
            
            // Hide all sections first
            userTypeSection.style.display = 'none';
            studentTypeSection.style.display = 'none';
            parkingPassSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            // Reset all selections
            document.getElementById('lookingUserType').selectedIndex = 0;
            document.getElementById('lookingStudentType').selectedIndex = 0;
            document.getElementById('lookingParkingPass').selectedIndex = 0;
            document.getElementById('lookingMessage').value = '';
            
            if (campus === 'ua-birmingham' || campus === 'ua-tuscaloosa' || campus === 'ua-huntsville' || campus === 'auburn') {
                userTypeSection.style.display = 'block';
            }
        }

        // Function to update parking passes for looking for a spot
        function updateLookingParkingPasses(campus, userType, studentType) {
            const parkingPassSection = document.getElementById('lookingParkingPassSection');
            const parkingPassSelect = document.getElementById('lookingParkingPass');
            
            // Clear existing options
            parkingPassSelect.innerHTML = '<option value="" selected disabled>Select your parking pass</option>';
            
            // Show parking pass section
            parkingPassSection.style.display = 'block';
            
            // Add options based on campus, user type, and student type
            if (campus === 'ua-birmingham') {
                if (userType === 'student' && studentType === 'residential') {
                    // UAB residential students get zone-based parking
                    parkingPassSelect.innerHTML += `
                        <option value="FallSpring – Zone A or Zone H">Fall/Spring Zone A or Zone H</option>
                        <option value="Fall (only) – Zone A or Zone H">Fall (only) Zone A or Zone H</option>
                        <option value="FallSpring – Zone D9A">Fall/Spring Zone D9A</option>
                        <option value="FallSpring – Zone B">Fall/Spring Zone B</option>
                        <option value="Fall (only) – Zone B">Fall (only) Zone B</option>
                        <option value="FallSpring – Zone D, E, F, G">Fall/Spring Zone D, E, F, G</option>
                    `;
                } else if (userType === 'student' && studentType === 'commuter') {
                    // UAB commuter students get zone-based parking
                    parkingPassSelect.innerHTML += `
                        <option value="Fall (only) – Zone D, E, F, G">Fall (only) Zone D, E, F, G</option>
                        <option value="FallSpring – Zone C">Fall/Spring Zone C</option>
                        <option value="Fall (only) – Zone C">Fall (only) Zone C</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // UAB faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="fs-parking">FS Parking</option>
                    `;
                }
            } else if (campus === 'ua-tuscaloosa') {
                if (userType === 'student' && studentType === 'residential') {
                    // UA Tuscaloosa residential students get color-based parking
                    parkingPassSelect.innerHTML += `
                        <option value="orange">Orange</option>
                        <option value="silver">Silver</option>
                        <option value="tan">Tan</option>
                        <option value="yellow">Yellow</option>
                    `;
                } else if (userType === 'student' && studentType === 'commuter') {
                    // UA Tuscaloosa commuter students get commuter-specific parking
                    parkingPassSelect.innerHTML += `
                        <option value="east-commuter">East Commuter</option>
                        <option value="west-commuter">West Commuter</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // UA Tuscaloosa faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="fs-parking">FS Parking</option>
                    `;
                }
            } else if (campus === 'ua-huntsville') {
                if (userType === 'student' && studentType === 'residential') {
                    // UAH residential students
                    parkingPassSelect.innerHTML += `
                        <option value="residential">Residential</option>
                    `;
                } else if (userType === 'student' && studentType === 'commuter') {
                    // UAH commuter students
                    parkingPassSelect.innerHTML += `
                        <option value="commuter">Commuter</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // UAH faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="faculty-staff">Faculty/Staff</option>
                    `;
                }
            } else if (campus === 'auburn') {
                if (userType === 'student') {
                    // Auburn students
                    parkingPassSelect.innerHTML += `
                        <option value="c-zone">C-zone</option>
                        <option value="pc">PC</option>
                        <option value="rd">RD</option>
                        <option value="rh">RH</option>
                        <option value="ro">RO</option>
                        <option value="rw">RW</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // Auburn faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="a-zone">A-zone</option>
                        <option value="b-zone">B-zone</option>
                    `;
                }
            }
        }

        // Function to update parking passes for giving up a spot
        function updateGivingParkingPasses(campus, userType, studentType) {
            const parkingPassSection = document.getElementById('givingParkingPassSection');
            const parkingPassSelect = document.getElementById('givingParkingPass');
            
            // Clear existing options
            parkingPassSelect.innerHTML = '<option value="" selected disabled>Select your parking pass</option>';
            
            // Show parking pass section
            parkingPassSection.style.display = 'block';
            
            // Add options based on campus, user type, and student type
            if (campus === 'ua-birmingham') {
                if (userType === 'student' && studentType === 'residential') {
                    // UAB residential students get zone-based parking
                    parkingPassSelect.innerHTML += `
                        <option value="FallSpring – Zone A or Zone H">Fall/Spring Zone A or Zone H</option>
                        <option value="Fall (only) – Zone A or Zone H">Fall (only) Zone A or Zone H</option>
                        <option value="FallSpring – Zone D9A">Fall/Spring Zone D9A</option>
                        <option value="FallSpring – Zone B">Fall/Spring Zone B</option>
                        <option value="Fall (only) – Zone B">Fall (only) Zone B</option>
                        <option value="FallSpring – Zone D, E, F, G">Fall/Spring Zone D, E, F, G</option>
                    `;
                } else if (userType === 'student' && studentType === 'commuter') {
                    // UAB commuter students get zone-based parking
                    parkingPassSelect.innerHTML += `
                        <option value="Fall (only) – Zone D, E, F, G">Fall (only) Zone D, E, F, G</option>
                        <option value="FallSpring – Zone C">Fall/Spring Zone C</option>
                        <option value="Fall (only) – Zone C">Fall (only) Zone C</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // UAB faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="fs-parking">FS Parking</option>
                    `;
                }
            } else if (campus === 'ua-tuscaloosa') {
                if (userType === 'student' && studentType === 'residential') {
                    // UA Tuscaloosa residential students get color-based parking
                    parkingPassSelect.innerHTML += `
                        <option value="orange">Orange</option>
                        <option value="silver">Silver</option>
                        <option value="tan">Tan</option>
                        <option value="yellow">Yellow</option>
                    `;
                } else if (userType === 'student' && studentType === 'commuter') {
                    // UA Tuscaloosa commuter students get commuter-specific parking
                    parkingPassSelect.innerHTML += `
                        <option value="east-commuter">East Commuter</option>
                        <option value="west-commuter">West Commuter</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // UA Tuscaloosa faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="fs-parking">FS Parking</option>
                    `;
                }
            } else if (campus === 'ua-huntsville') {
                if (userType === 'student' && studentType === 'residential') {
                    // UAH residential students
                    parkingPassSelect.innerHTML += `
                        <option value="residential">Residential</option>
                    `;
                } else if (userType === 'student' && studentType === 'commuter') {
                    // UAH commuter students
                    parkingPassSelect.innerHTML += `
                        <option value="commuter">Commuter</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // UAH faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="faculty-staff">Faculty/Staff</option>
                    `;
                }
            } else if (campus === 'auburn') {
                if (userType === 'student') {
                    // Auburn students
                    parkingPassSelect.innerHTML += `
                        <option value="c-zone">C-zone</option>
                        <option value="pc">PC</option>
                        <option value="rd">RD</option>
                        <option value="rh">RH</option>
                        <option value="ro">RO</option>
                        <option value="rw">RW</option>
                    `;
                } else if (userType === 'faculty-staff') {
                    // Auburn faculty/staff
                    parkingPassSelect.innerHTML += `
                        <option value="a-zone">A-zone</option>
                        <option value="b-zone">B-zone</option>
                    `;
                }
            }
        }

        // Helper functions for updating form sections
        function updateGivingUserType() {
            const campus = document.getElementById('givingCampus').value;
            const userType = document.getElementById('givingUserType').value;
            const studentTypeSection = document.getElementById('givingStudentTypeSection');
            const parkingPassSection = document.getElementById('givingParkingPassSection');
            const timeSection = document.getElementById('givingTimeSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            // Hide all sections first
            studentTypeSection.style.display = 'none';
            parkingPassSection.style.display = 'none';
            timeSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            if (userType === 'student' && campus !== 'auburn') {
                studentTypeSection.style.display = 'block';
            } else if (userType && campus) {
                updateGivingParkingPasses(campus, userType, '');
            }
        }

        function updateGivingStudentType() {
            const campus = document.getElementById('givingCampus').value;
            const userType = document.getElementById('givingUserType').value;
            const studentType = document.getElementById('givingStudentType').value;
            
            if (campus && userType && studentType) {
                updateGivingParkingPasses(campus, userType, studentType);
            }
        }

        function updateGivingParkingPass() {
            const timeSection = document.getElementById('givingTimeSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            if (document.getElementById('givingParkingPass').value) {
                timeSection.style.display = 'block';
            }
        }

        function updateLookingUserType() {
            const campus = document.getElementById('lookingCampus').value;
            const userType = document.getElementById('lookingUserType').value;
            const studentTypeSection = document.getElementById('lookingStudentTypeSection');
            const parkingPassSection = document.getElementById('lookingParkingPassSection');
            const messageSection = document.getElementById('lookingMessageSection');
            
            // Hide all sections first
            studentTypeSection.style.display = 'none';
            parkingPassSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            if (userType === 'student' && campus !== 'auburn') {
                studentTypeSection.style.display = 'block';
            } else if (userType && campus) {
                updateLookingParkingPasses(campus, userType, '');
            }
        }

        function updateLookingStudentType() {
            const campus = document.getElementById('lookingCampus').value;
            const userType = document.getElementById('lookingUserType').value;
            const studentType = document.getElementById('lookingStudentType').value;
            
            if (campus && userType && studentType) {
                updateLookingParkingPasses(campus, userType, studentType);
            }
        }

        function updateLookingParkingPass() {
            const messageSection = document.getElementById('lookingMessageSection');
            
            if (document.getElementById('lookingParkingPass').value) {
                messageSection.style.display = 'block';
            }
        }

        // Function for "Giving up a Spot" campus selection
        function updateParkingLocations() {
            const campus = document.getElementById('givingCampus').value;
            const userTypeSection = document.getElementById('givingUserTypeSection');
            const studentTypeSection = document.getElementById('givingStudentTypeSection');
            const parkingPassSection = document.getElementById('givingParkingPassSection');
            const timeSection = document.getElementById('givingTimeSection');
            const messageSection = document.getElementById('givingMessageSection');
            
            // Hide all sections first
            userTypeSection.style.display = 'none';
            studentTypeSection.style.display = 'none';
            parkingPassSection.style.display = 'none';
            timeSection.style.display = 'none';
            messageSection.style.display = 'none';
            
            // Reset all selections
            document.getElementById('givingUserType').selectedIndex = 0;
            document.getElementById('givingStudentType').selectedIndex = 0;
            document.getElementById('givingParkingPass').selectedIndex = 0;
            document.getElementById('givingTime').selectedIndex = 0;
            document.getElementById('givingMessage').value = '';
            
            if (campus === 'ua-birmingham' || campus === 'ua-tuscaloosa' || campus === 'ua-huntsville' || campus === 'auburn') {
                userTypeSection.style.display = 'block';
            }
        }

        // Store spot data when someone gives up a spot
        function storeSpotData(accountName, campus, location, timeWait, message, carYear, carMake, carModel, carColor, floor) {
            const accounts = JSON.parse(localStorage.getItem('parkingAccounts') || '[]');
            const account = accounts.find(acc => acc.name.toLowerCase() === accountName.toLowerCase());
            
            if (account) {
                const spotData = {
                    id: Date.now(), // Unique ID
                    accountName: accountName,
                    campus: campus,
                    location: location,
                    timeWait: timeWait,
                    message: message,
                    carYear: carYear,
                    carMake: carMake,
                    carModel: carModel,
                    carColor: carColor,
                    floor: floor,
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + (parseInt(timeWait) * 60 * 1000)).toISOString()
                };
                
                const spots = JSON.parse(localStorage.getItem('availableSpots') || '[]');
                spots.push(spotData);
                localStorage.setItem('availableSpots', JSON.stringify(spots));
                
                // Remove expired spots
                cleanupExpiredSpots();
            }
        }

        // Get user's active requests
        function getUserActiveRequests(accountName) {
            const availableSpots = JSON.parse(localStorage.getItem('availableSpots') || '[]');
            const now = new Date();
            
            return availableSpots.filter(spot => 
                spot.accountName === accountName && 
                new Date(spot.expiresAt) > now
            );
        }

        // Remove a specific request
        function removeRequest(requestId) {
            let availableSpots = JSON.parse(localStorage.getItem('availableSpots') || '[]');
            availableSpots = availableSpots.filter(spot => spot.id !== requestId);
            localStorage.setItem('availableSpots', JSON.stringify(availableSpots));
            
            // Refresh the display
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                displayUserActiveRequests(currentUser.name);
            }
        }

        // Display user's active requests
        function displayUserActiveRequests(accountName) {
            const activeRequests = getUserActiveRequests(accountName);
            const requestsContainer = document.getElementById('userActiveRequests');
            
            if (activeRequests.length === 0) {
                requestsContainer.innerHTML = '<p class="text-muted">No active requests</p>';
                return;
            }

            let html = '<h6 class="fw-bold mb-3">Your Active Requests:</h6>';
            activeRequests.forEach(request => {
                const timeRemaining = Math.max(0, Math.floor((new Date(request.expiresAt) - new Date()) / 1000 / 60));
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <small class="text-muted">${request.campus} - ${request.location}</small><br>
                                    <small><strong>${request.carYear} ${request.carMake} ${request.carModel}</strong> (${request.carColor})</small><br>
                                    <small class="text-muted">Floor: ${request.floor}</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-warning">${timeRemaining} min left</small><br>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeRequest(${request.id})">
                                        <i class="fas fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            requestsContainer.innerHTML = html;
        }

        // Find matching spot for someone looking
        function findMatchingSpot(campus, location) {
            cleanupExpiredSpots();
            const spots = JSON.parse(localStorage.getItem('availableSpots') || '[]');
            
            // Find first matching spot
            const match = spots.find(spot => 
                spot.campus === campus && 
                spot.location === location &&
                new Date(spot.expiresAt) > new Date()
            );
            
            return match;
        }

        // Display car information when match is found
        function displayCarInformation(match) {
            const timeRemaining = Math.max(0, Math.ceil((new Date(match.expiresAt) - new Date()) / 60000));
            
            const carInfoHTML = `
                <div class="alert alert-success mt-3" id="matchFound">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="alert-heading">🎉 Spot Found!</h5>
                            <p><strong>Location:</strong> ${match.campus} - ${match.location}</p>
                            <p><strong>Car Details:</strong></p>
                            <ul class="mb-2">
                                <li><strong>Year:</strong> ${match.carYear}</li>
                                <li><strong>Make:</strong> ${match.carMake}</li>
                                <li><strong>Model:</strong> ${match.carModel}</li>
                                <li><strong>Color:</strong> ${match.carColor}</li>
                                <li><strong>Floor/Level:</strong> ${match.floor}</li>
                                <li><strong>Posted by:</strong> ${match.accountName}</li>
                            </ul>
                            ${match.message ? `<p><strong>Additional Info:</strong> ${match.message}</p>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="h4 text-warning mb-1">${timeRemaining}</div>
                            <small class="text-muted">minutes left</small>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Hurry! This spot expires in ${timeRemaining} minutes.</small>
                        <button class="btn btn-sm btn-outline-success" onclick="document.getElementById('matchFound').style.display='none'">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            
            // Insert after the looking form
            const lookingForm = document.querySelector('#lookingCampus').closest('.card');
            const existingMatch = document.getElementById('matchFound');
            const existingNoSpots = document.getElementById('noSpotsFound');
            
            if (existingMatch) {
                existingMatch.remove();
            }
            if (existingNoSpots) {
                existingNoSpots.remove();
            }
            
            lookingForm.insertAdjacentHTML('afterend', carInfoHTML);
        }

        // Show no spots message without resetting form
        function showNoSpotsMessage() {
            const noSpotsHTML = `
                <div class="alert alert-warning mt-3" id="noSpotsFound">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="alert-heading">🔍 No Spots Available</h5>
                            <p>No available spots found for your parking pass at this time.</p>
                            <p class="mb-0">Don't worry! New spots are posted frequently. Try again in a few minutes.</p>
                        </div>
                        <div class="col-md-4 text-end d-flex align-items-center">
                            <button class="btn btn-primary" onclick="retryLookingForSpot()">
                                <i class="fas fa-redo me-1"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after the looking form
            const lookingForm = document.querySelector('#lookingCampus').closest('.card');
            const existingMatch = document.getElementById('matchFound');
            const existingNoSpots = document.getElementById('noSpotsFound');
            
            if (existingMatch) {
                existingMatch.remove();
            }
            if (existingNoSpots) {
                existingNoSpots.remove();
            }
            
            lookingForm.insertAdjacentHTML('afterend', noSpotsHTML);
        }

        // Retry looking for a spot
        function retryLookingForSpot() {
            // Remove the no spots message
            const existingNoSpots = document.getElementById('noSpotsFound');
            if (existingNoSpots) {
                existingNoSpots.remove();
            }
            
            // Trigger the form submission again
            const form = document.querySelector('#lookingCampus').closest('form');
            form.dispatchEvent(new Event('submit'));
        }

        // Clean up expired spots
        function cleanupExpiredSpots() {
            const spots = JSON.parse(localStorage.getItem('availableSpots') || '[]');
            const activeSpots = spots.filter(spot => new Date(spot.expiresAt) > new Date());
            localStorage.setItem('availableSpots', JSON.stringify(activeSpots));
        }

        // Clean up expired looking requests
        function cleanupExpiredLookingRequests() {
            const requests = JSON.parse(localStorage.getItem('lookingRequests') || '[]');
            const active = requests.filter(req => new Date(req.expiresAt) > new Date());
            localStorage.setItem('lookingRequests', JSON.stringify(active));
        }

        // Countdown timer function
        function startCountdown(minutes) {
            const countdownSection = document.getElementById('countdownSection');
            const countdownTimer = document.getElementById('countdownTimer');
            
            // Show countdown section
            countdownSection.style.display = 'block';
            
            // Calculate total seconds
            let totalSeconds = minutes * 60;
            
            // Update timer display
            function updateTimer() {
                const remainingMinutes = Math.floor(totalSeconds / 60);
                const remainingSeconds = totalSeconds % 60;
                
                // Format with leading zeros
                const formattedMinutes = remainingMinutes.toString().padStart(2, '0');
                const formattedSeconds = remainingSeconds.toString().padStart(2, '0');
                
                countdownTimer.textContent = `${formattedMinutes}:${formattedSeconds}`;
                
                // Change color as time runs out
                if (totalSeconds <= 60) {
                    countdownTimer.classList.remove('text-primary');
                    countdownTimer.classList.add('text-danger');
                } else if (totalSeconds <= 180) {
                    countdownTimer.classList.remove('text-primary');
                    countdownTimer.classList.add('text-warning');
                }
                
                if (totalSeconds <= 0) {
                    // Timer finished
                    clearInterval(timerInterval);
                    countdownSection.innerHTML = `
                        <div class="text-center">
                            <strong>Time's Up!</strong> Your spot is no longer available.
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="document.getElementById('countdownSection').style.display='none'">
                                Close
                            </button>
                        </div>
                    `;
                    return;
                }
                
                totalSeconds--;
            }
            
            // Update immediately and then every second
            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);
        }
        
        // Refresh active requests display every 30 seconds
        setInterval(() => {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                displayUserActiveRequests(currentUser.name);
            }
        }, 30000);
        
        // Initial display of active requests if user is signed in
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (currentUser) {
            displayUserActiveRequests(currentUser.name);
        }
    </script>
</body>
</html>